@page "/generator"
@inject AppointmentService AppointmentService
@inject DoctorService DoctorService
@inject PatientService PatientService
@inject NavigationManager Nav

<div class="p-8 max-w-4xl mx-auto space-y-8 font-sans">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
        <div>
            <h1 class="text-3xl font-bold text-slate-900 tracking-tight flex items-center gap-3">
                <svg class="w-8 h-8 text-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                    <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                    <line x1="12" y1="22.08" x2="12" y2="12"></line>
                </svg>
                Diagnostic Data Generator
            </h1>
            <p class="text-slate-500 font-medium">Bulk populate your system with randomized clinical records for testing.</p>
        </div>
    </div>

    <div class="bg-white rounded-[2.5rem] border border-slate-200 shadow-xl overflow-hidden">
        <div class="bg-slate-900 p-8 text-white">
            <h3 class="text-sm font-black uppercase tracking-[0.2em] mb-4 opacity-50">Configuration</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="space-y-2">
                    <label class="text-[10px] font-black uppercase tracking-widest text-slate-400">Start Range</label>
                    <input type="date" class="w-full bg-slate-800 border-none rounded-2xl px-5 py-4 font-bold text-white focus:ring-2 focus:ring-primary outline-none transition-all" @bind="startDate" />
                </div>
                <div class="space-y-2">
                    <label class="text-[10px] font-black uppercase tracking-widest text-slate-400">End Range</label>
                    <input type="date" class="w-full bg-slate-800 border-none rounded-2xl px-5 py-4 font-bold text-white focus:ring-2 focus:ring-primary outline-none transition-all" @bind="endDate" />
                </div>
            </div>
        </div>

        <div class="p-8 space-y-8">
            <div class="flex items-start gap-4 p-6 bg-emerald-50 rounded-3xl border border-emerald-100">
                <div class="w-12 h-12 bg-white rounded-2xl flex items-center justify-center text-primary shadow-sm shrink-0">
                    <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4"></path><path d="M12 8h.01"></path></svg>
                </div>
                <div>
                    <h4 class="font-black text-slate-900">Generation Logic</h4>
                    <p class="text-sm text-slate-600 font-medium leading-relaxed">The system will generate between **10 to 20 appointments** for every single date chosen. Appointments are automatically scheduled between **9:00 AM and 9:00 PM**, assigning random patients and doctors from the registry.</p>
                </div>
            </div>

            @if (isGenerating)
            {
                <div class="space-y-4 py-8">
                    <div class="flex justify-between items-end mb-2">
                        <span class="text-xs font-black text-slate-400 uppercase tracking-widest">Processing Batch: @currentDate.ToString("dd MMM yyyy")</span>
                        <span class="text-sm font-black text-primary italic">@progress%</span>
                    </div>
                    <div class="h-4 bg-slate-100 rounded-full overflow-hidden">
                        <div class="h-full bg-primary transition-all duration-300" style="width: @progress%"></div>
                    </div>
                    <p class="text-center text-slate-400 text-xs font-bold animate-pulse uppercase tracking-widest">Writing clinical records to IndexedDB...</p>
                </div>
            }
            else
            {
                <div class="flex flex-col items-center gap-4">
                    <button class="w-full md:w-auto bg-primary hover:bg-emerald-700 text-white px-12 py-5 rounded-2xl font-black uppercase tracking-widest text-sm shadow-xl hover:shadow-emerald-500/20 transition-all active:scale-95 disabled:opacity-50 disabled:pointer-events-none" 
                            disabled="@(startDate > endDate)"
                            @onclick="GenerateAllData">
                        Initialize Global Registry
                    </button>
                    <p class="text-[10px] font-black text-slate-300 uppercase tracking-[0.2em]">Validated Diagnostic Tool</p>
                </div>
            }
        </div>
    </div>

    @if (!string.IsNullOrEmpty(resultMessage))
    {
        <div class="animate-in fade-in slide-in-from-bottom duration-500 flex items-center justify-between p-6 bg-white rounded-3xl border border-slate-200 shadow-lg">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 bg-emerald-100 text-emerald-600 rounded-xl flex items-center justify-center">
                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg>
                </div>
                <div>
                    <div class="text-sm font-black text-slate-900">@resultMessage</div>
                    <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Batch Process Complete</div>
                </div>
            </div>
            <button class="text-xs font-black text-primary uppercase tracking-widest hover:underline" @onclick='() => Nav.NavigateTo("appointments")'>View Results</button>
        </div>
    }
</div>

@code {
    private DateTime startDate = DateTime.Today;
    private DateTime endDate = DateTime.Today.AddDays(7);
    private bool isGenerating = false;
    private int progress = 0;
    private DateTime currentDate;
    private string resultMessage = "";

    private async Task GenerateAllData()
    {
        isGenerating = true;
        resultMessage = "";
        progress = 0;
        
        var rnd = new Random();
        
        // 1. Ensure we have doctors and patients
        var docRes = await DoctorService.GetDoctorsAsync(page: 1, pageSize: 100);
        var doctors = (docRes.IsSuccess && docRes.Data != null && docRes.Data.Items != null) ? docRes.Data.Items.ToList() : new List<DoctorsResModel>();
        
        var patRes = await PatientService.GetPatientsAsync(page: 1, pageSize: 100);
        var patients = (patRes.IsSuccess && patRes.Data != null && patRes.Data.Items != null) ? patRes.Data.Items.ToList() : new List<PatientResModel>();

        // If no doctors/patients, create some defaults
        if (!doctors.Any())
        {
            await DoctorService.RegisterDoctorAsync(new() { Name = "John Smith", SpecializationId = 1 });
            await DoctorService.RegisterDoctorAsync(new() { Name = "Sarah Connor", SpecializationId = 2 });
            await DoctorService.RegisterDoctorAsync(new() { Name = "Robert Wilson", SpecializationId = 3 });
            var updatedDocs = await DoctorService.GetDoctorsAsync(page: 1, pageSize: 100);
            doctors = updatedDocs.Data?.Items?.ToList() ?? new List<DoctorsResModel>();
        }

        if (!patients.Any())
        {
            await PatientService.RegisterPatientAsync(new() { Name = "Alice Wonderland", DateOfBirth = DateTime.Today.AddYears(-25), Gender = "Female", Phone = "0977889900" });
            await PatientService.RegisterPatientAsync(new() { Name = "Bob Builder", DateOfBirth = DateTime.Today.AddYears(-45), Gender = "Male", Phone = "0977889123" });
            await PatientService.RegisterPatientAsync(new() { Name = "Charlie Bucket", DateOfBirth = DateTime.Today.AddYears(-12), Gender = "Male", Phone = "0977889456" });
            var updatedPats = await PatientService.GetPatientsAsync(page: 1, pageSize: 100);
            patients = updatedPats.Data?.Items?.ToList() ?? new List<PatientResModel>();
        }

        // 2. Generate appointments for each day
        var totalDays = (endDate - startDate).Days + 1;
        int processedDays = 0;
        
        if (doctors.Any() && patients.Any())
        {
            for (var date = startDate; date <= endDate; date = date.AddDays(1))
            {
                currentDate = date;
                int count = rnd.Next(10, 21); // 10 to 20 rows
                
                for (int i = 0; i < count; i++)
                {
                    var hour = rnd.Next(9, 21); // 9 AM to 9 PM
                    var minute = rnd.Next(0, 2) * 30; // Only 0 or 30
                    var apptDate = date.Date.AddHours(hour).AddMinutes(minute);
                    
                    var patient = patients[rnd.Next(patients.Count)];
                    var doctor = doctors[rnd.Next(doctors.Count)];

                    // Allow 30, 60, 90, 120 minutes
                    int[] durations = { 30, 60, 90, 120 };
                    int duration = durations[rnd.Next(durations.Length)];

                    await AppointmentService.CreateAppointmentAsync(new AppointmentReqModel
                    {
                        PatientId = patient.Id,
                        DoctorId = doctor.Id,
                        AppointmentDate = apptDate,
                        AppointmentNumber = rnd.Next(100000, 999999),
                        Status = "Active",
                        Cost = rnd.Next(4, 17) * 5000, // Range 20,000 - 80,000 (5,000 step)
                        DurationMinutes = duration,
                        Notes = "Automatically generated diagnostic record for system validation."
                    });
                }

                processedDays++;
                progress = (int)((double)processedDays / totalDays * 100);
                StateHasChanged();
                await Task.Delay(100); // Small UI delay to see progress
            }
        }

        isGenerating = false;
        resultMessage = $"Successfully synchronized clinical records for {processedDays} days.";
    }
}
