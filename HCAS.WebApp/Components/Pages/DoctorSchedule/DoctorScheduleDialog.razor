@using HCAS.Domain.Features.DoctorSchedule
@using HCAS.Shared
@using MudBlazor
@inject DoctorScheduleService doctorScheduleService
@inject ISnackbar Snackbar

<MudDialog Style="min-width: 500px;">
    <DialogContent>
        @if (_loading)
        {
            <div class="d-flex justify-center pa-4">
                <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
            </div>
        }
        else
        {
            <MudText Typo="Typo.h6" Class="mb-4">@(_isEdit ? "Edit Schedule" : "Add Schedule")</MudText>

            <MudForm @ref="form" @bind-IsValid="@_isFormValid" @bind-Errors="@_errors">
                <MudGrid>
                    <MudItem xs="12">
                        <MudSelect T="int?"
                                   Label="Doctor Name"
                                   @bind-Value="doctorId"
                                   Required="true"
                                   RequiredError="Please select a doctor"
                                   Variant="MudBlazor.Variant.Outlined">
                            <MudSelectItem Value="@((int?)null)" Disabled="true">Select Doctor</MudSelectItem>
                            @foreach (var doctor in Doctors)
                            {
                                <MudSelectItem Value="@((int?)doctor.Id)">@doctor.Name</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>

                    <MudItem xs="12" md="6">
                        <MudDatePicker Label="Schedule Date"
                                       @bind-Date="scheduleDateValue"
                                       Required="true"
                                       RequiredError="Please select a schedule date"
                                       MinDate="DateTime.Today"
                                       Placeholder="Select schedule date"
                                       Variant="MudBlazor.Variant.Outlined" />
                    </MudItem>

                    <MudItem xs="12" md="6">
                        <MudTextField Label="Schedule Time"
                                      @bind-Value="scheduleTimeValue"
                                      InputType="InputType.Time"
                                      Required="true"
                                      RequiredError="Please select a schedule time"
                                      Placeholder="Select time (HH:mm)"
                                      Variant="MudBlazor.Variant.Outlined"
                                      HelperText="Select the available time slot" />
                    </MudItem>

                    <MudItem xs="12">
                        <MudNumericField T="int?"
                                         Label="Maximum Patients"
                                         @bind-Value="maxPatients"
                                         Required="true"
                                         RequiredError="Please enter maximum patients"
                                         Min="1"
                                         Max="100"
                                         Placeholder="Enter maximum number of patients"
                                         Variant="MudBlazor.Variant.Outlined" />
                    </MudItem>
                </MudGrid>

                @if (_errors.Length > 0)
                {
                    <MudAlert Severity="Severity.Error" Class="mt-3">
                        @foreach (var error in _errors)
                        {
                            <div>@error</div>
                        }
                    </MudAlert>
                }
            </MudForm>
        }
    </DialogContent>

    <DialogActions>
        <MudButton Color="Color.Secondary" OnClick="Cancel" Disabled="_loading">Cancel</MudButton>
        <MudButton Color="Color.Primary"
                   OnClick="SaveSchedule"
                   Disabled="@(!_isFormValid || _loading)"
                   Variant="MudBlazor.Variant.Filled">
            @if (_loading)
            {
                <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                <MudText Class="ms-2">Saving...</MudText>
            }
            else
            {
                <MudText>Save</MudText>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = default!;
    [Parameter] public DoctorScheduleResModel? Schedule { get; set; }

    private List<DoctorModel> Doctors = new List<DoctorModel>();
    private DateTime? scheduleDateValue;
    private string scheduleTimeValue = "09:00"; // Default time: 9:00 AM
    private int? doctorId;
    private int? maxPatients;
    private bool _loading = false;
    private bool _isEdit => Schedule is not null;
    private bool _isFormValid = false;
    private string[] _errors = Array.Empty<string>();
    private MudForm form = default!;

    protected override async Task OnInitializedAsync()
    {
        _loading = true;

        if (_isEdit && Schedule is not null)
        {
            doctorId = Schedule.DoctorId;
            scheduleDateValue = Schedule.ScheduleDate;
            
            // Extract time from schedule date
            if (Schedule.ScheduleDate.HasValue)
            {
                scheduleTimeValue = Schedule.ScheduleDate.Value.ToString("HH:mm");
            }
            else
            {
                scheduleTimeValue = "09:00";
            }
            
            maxPatients = Schedule.MaxPatients;
        }
        else
        {
            scheduleDateValue = DateTime.Today.AddDays(1); // Default to tomorrow
            scheduleTimeValue = "09:00"; // Default time: 9:00 AM
            doctorId = null;
            maxPatients = null;
        }

        var result = await doctorScheduleService.GetDoctors();
        Doctors = result?.ToList() ?? new List<DoctorModel>();

        _loading = false;
        StateHasChanged();
    }

    private async Task SaveSchedule()
    {
        await form.Validate();

        if (!_isFormValid)
            return;

        // Validate required fields manually since form validation might not catch nullable issues
        if (!doctorId.HasValue)
        {
            Snackbar.Add("Please select a doctor", Severity.Error);
            return;
        }

        if (!scheduleDateValue.HasValue)
        {
            Snackbar.Add("Please select a schedule date", Severity.Error);
            return;
        }

        if (string.IsNullOrWhiteSpace(scheduleTimeValue))
        {
            Snackbar.Add("Please select a schedule time", Severity.Error);
            return;
        }

        if (!maxPatients.HasValue || maxPatients.Value <= 0)
        {
            Snackbar.Add("Please enter a valid number of maximum patients", Severity.Error);
            return;
        }

        // Combine date and time
        DateTime combinedDateTime;
        if (TimeSpan.TryParse(scheduleTimeValue, out var timeSpan))
        {
            combinedDateTime = scheduleDateValue.Value.Date.Add(timeSpan);
        }
        else
        {
            Snackbar.Add("Invalid time format. Please use HH:mm format (e.g., 09:00)", Severity.Error);
            return;
        }

        // Validate that combined date/time is not in the past
        if (combinedDateTime < DateTime.Now)
        {
            Snackbar.Add("Schedule date and time cannot be in the past", Severity.Error);
            return;
        }

        _loading = true;

        var scheduleModel = new DoctorScheduleReqModel
            {
                DoctorId = doctorId.Value,
                ScheduleDate = combinedDateTime,
                MaxPatients = maxPatients.Value
            };

        Result<DoctorScheduleResModel> result;
        if (_isEdit && Schedule is not null)
        {
            result = await doctorScheduleService.UpdateScheduleAsync(Schedule.Id, scheduleModel);
        }
        else
        {
            result = await doctorScheduleService.CreateScheduleAsync(scheduleModel);
        }

        _loading = false;

        if (result.IsSuccess)
        {
            Snackbar.Add(result.Message, Severity.Success);
            MudDialog.Close(DialogResult.Ok(true));
        }
        else
        {
            Snackbar.Add(result.Message, Severity.Error);
        }
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }
}